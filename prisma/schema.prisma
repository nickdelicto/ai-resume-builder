generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                 String                 @id @default(cuid())
  name               String?
  email              String?                @unique
  emailVerified      DateTime?
  image              String?
  isNewUser          Boolean                @default(true)
  planType           String                 @default("free")
  planExpirationDate DateTime?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  accounts           Account[]
  resumeData         ResumeData[]
  sessions           Session[]
  subscriptions      UserSubscription[]
  feedback           FeedbackEntry[]
  events             UserEvent[]
  discounts          SubscriptionDiscount[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ResumeData {
  id        String   @id @default(cuid())
  userId    String
  title     String   @default("Untitled Resume")
  data      Json
  template  String   @default("ats")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SubscriptionPlan {
  id                String             @id @default(cuid())
  name              String
  description       String
  price             Float
  interval          String
  stripePriceId     String?
  isPopular         Boolean            @default(false)
  isActive          Boolean            @default(true)
  features          String[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userSubscriptions UserSubscription[]
}

model UserSubscription {
  id                    String                 @id @default(cuid())
  userId                String
  planId                String
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  stripePaymentIntentId String?
  status                String
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean                @default(false)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  metadata              Json?
  plan                  SubscriptionPlan       @relation(fields: [planId], references: [id])
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  discounts             SubscriptionDiscount[]
}

model KVStore {
  key       String   @id
  value     String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Add FeedbackEntry model for storing cancellation feedback
model FeedbackEntry {
  id        String   @id @default(cuid())
  userId    String
  type      String // e.g., 'cancellation', 'feature_request', etc.
  content   Json // Flexible structure for different types of feedback
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Add UserEvent model for analytics
model UserEvent {
  id        String   @id @default(cuid())
  userId    String
  type      String // e.g., 'retention_discount_applied', 'subscription_canceled', etc.
  metadata  Json? // Additional data about the event
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Add SubscriptionDiscount model for tracking discounts
model SubscriptionDiscount {
  id              String    @id @default(cuid())
  subscriptionId  String
  userId          String
  discountPercent Float
  originalPrice   Float
  discountedPrice Float
  stripeCouponId  String?
  appliedAt       DateTime  @default(now())
  expiresAt       DateTime? // Null means forever
  isActive        Boolean   @default(true)
  reason          String? // e.g., 'retention', 'promotion', etc.
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  subscription UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// RN Job Board Models - For Programmatic SEO Job Board Feature
// ============================================================================

// Stores information about healthcare employers we scrape jobs from
model HealthcareEmployer {
  id            String       @id @default(cuid())
  name          String       @unique // Company name like "Cleveland Clinic"
  slug          String       @unique // URL-friendly version like "cleveland-clinic" for /jobs/nursing/cleveland-clinic
  careerPageUrl String // Where we scrape from
  atsPlatform   String? // ATS platform used: "custom", "workday", "icims", etc.
  isActive      Boolean      @default(true) // Whether we're still scraping from them
  lastScraped   DateTime? // When we last scraped them
  jobs          NursingJob[] // All job postings from this employer
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([isActive, lastScraped])
}

// Stores individual RN job postings scraped from healthcare employers
model NursingJob {
  id String @id @default(cuid())

  // Basic Information
  title      String // Job title like "ICU Registered Nurse"
  employerId String // Which company this job is from
  employer   HealthcareEmployer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  // Location Information (critical for SEO location-based pages)
  location String // Full location string like "Mayfield Heights, OH 44124"
  city     String // Normalized city name like "Mayfield Heights"
  state    String // Normalized state abbreviation like "OH"
  zipCode  String? // Optional zip code
  isRemote Boolean @default(false) // True if remote position

  // Job Classification (for specialty pages and filtering)
  jobType         String? // Employment type: "full-time", "part-time", "prn", "contract"
  shiftType       String? // Shift type: "days", "nights", "evenings", "variable", "rotating"
  specialty       String? // RN specialty: "ICU", "ER", "Travel", "Med-Surg", "Home Health", etc.
  experienceLevel String? // Experience required: "new-grad", "experienced", "senior"

  // Job Details
  description      String  @db.Text // Full job description
  requirements     String? @db.Text // Qualifications and requirements
  responsibilities String? @db.Text // Job responsibilities
  benefits         String? @db.Text // Benefits information if available
  department       String? // Department or facility name

  // Compensation Information (if available)
  salaryMin      Int? // Minimum salary if listed (raw value as scraped)
  salaryMax      Int? // Maximum salary if listed (raw value as scraped)
  salaryCurrency String? @default("USD") // Currency code
  salaryType     String? // "hourly" or "annual" - how the salary is specified
  // Normalized values for comparison/statistics (allows comparing hourly vs annual jobs)
  salaryMinHourly Int? // Normalized hourly equivalent (annual/2080 if annual, same if hourly)
  salaryMaxHourly Int? // Normalized hourly equivalent
  salaryMinAnnual Int? // Normalized annual equivalent (hourly*2080 if hourly, same if annual)
  salaryMaxAnnual Int? // Normalized annual equivalent

  // Source Tracking
  sourceUrl   String  @unique // Original job posting URL where users can apply
  sourceJobId String? // Job ID from employer's system (for deduplication)

  // Status Tracking
  isActive            Boolean   @default(true) // Whether job is still open
  postedDate          DateTime? // When job was posted (if available)
  expiresDate         DateTime? // When job expires (if available from source)
  calculatedExpiresDate DateTime? // Calculated expiry (scrapedAt + 60 days) if no expiresDate provided
  classifiedAt        DateTime? // When job was classified by LLM (null = needs classification)

  // SEO Fields (for programmatic SEO pages)
  slug            String   @unique // URL-friendly version like "icu-rn-mayfield-heights-12345"
  metaDescription String? // Short description for SEO meta tags
  keywords        String[] // Array of keywords for AI SEO like ["icu", "registered nurse", "ohio"]

  // Timestamps
  scrapedAt DateTime @default(now()) // When we scraped this job
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for fast queries
  @@index([state, city]) // For location-based pages like /jobs/nursing/ohio/chicago
  @@index([specialty]) // For specialty pages like /jobs/nursing/icu
  @@index([employerId, isActive]) // For employer pages like /jobs/nursing/cleveland-clinic
  @@index([isActive, scrapedAt]) // For filtering active jobs by freshness
  @@index([slug]) // For job detail page lookups
  @@index([jobType, specialty]) // For filtering by type and specialty
}

// Reference table for normalized location data (prevents duplicates and ensures consistency)
model Location {
  id        String  @id @default(cuid())
  city      String // City name
  state     String // State abbreviation like "OH"
  stateFull String // Full state name like "Ohio"
  region    String? // Optional region like "Midwest", "Northeast", etc.

  @@unique([city, state])
  @@index([state])
}

// Track deleted job slugs to return 410 Gone instead of 404 Not Found
// This improves SEO by telling search engines the page is permanently removed
model DeletedJob {
  id        String   @id @default(cuid())
  slug      String   @unique // The job slug that was deleted
  deletedAt DateTime @default(now()) // When it was deleted
  reason    String?  // Optional: why it was deleted (e.g., "testing cleanup", "duplicate", etc.)

  @@index([slug]) // Fast lookup when checking if a slug was deleted
}

// Job alert subscriptions for email notifications
// Users can sign up from salary calculator or job pages to receive matching job alerts
model JobAlert {
  id               String   @id @default(cuid())
  email            String   // User's email address
  name             String?  // Optional: User's name for personalization
  
  // Alert criteria (what jobs to match)
  specialty        String   // e.g., "ICU", "ER", "Med-Surg"
  location         String   // Human-readable: "Cleveland, OH" or "Ohio" or "Nationwide"
  state            String?  // State code: "OH", "CA", etc.
  city             String?  // City name if location is city-specific
  employerId       String?  // Optional: Filter by specific employer
  employer         HealthcareEmployer? @relation(fields: [employerId], references: [id])
  
  // Metadata
  source           String   // Where they signed up: "salary-calculator", "job-page", etc.
  active           Boolean  @default(true) // Can be toggled off without deleting
  unsubscribeToken String   @unique @default(cuid()) // Magic token for preference management
  
  // Timestamps
  createdAt        DateTime @default(now())
  lastEmailSent    DateTime? // Track when we last sent them jobs
  
  @@index([email, active]) // Fast lookup for active alerts by email
  @@index([specialty, state]) // Fast lookup for matching jobs
  @@index([unsubscribeToken]) // Fast token validation
  @@map("jobalert") // Explicitly map to lowercase table name (PostgreSQL default)
}
