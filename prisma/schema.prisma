generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                 String                 @id @default(cuid())
  name               String?
  email              String?                @unique
  emailVerified      DateTime?
  image              String?
  isNewUser          Boolean                @default(true)
  planType           String                 @default("free")
  planExpirationDate DateTime?
  freeDownloadsUsed  Int                    @default(0)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  accounts           Account[]
  feedback           FeedbackEntry[]
  resumeData         ResumeData[]
  sessions           Session[]
  discounts          SubscriptionDiscount[]
  events             UserEvent[]
  subscriptions      UserSubscription[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ResumeData {
  id        String   @id @default(cuid())
  userId    String
  title     String   @default("Untitled Resume")
  data      Json
  template  String   @default("ats")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SubscriptionPlan {
  id                String             @id @default(cuid())
  name              String
  description       String
  price             Float
  interval          String
  stripePriceId     String?
  isPopular         Boolean            @default(false)
  isActive          Boolean            @default(true)
  features          String[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userSubscriptions UserSubscription[]
}

model UserSubscription {
  id                    String                 @id @default(cuid())
  userId                String
  planId                String
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  stripePaymentIntentId String?
  status                String
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean                @default(false)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  metadata              Json?
  discounts             SubscriptionDiscount[]
  plan                  SubscriptionPlan       @relation(fields: [planId], references: [id])
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model KVStore {
  key       String   @id
  value     String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FeedbackEntry {
  id        String   @id @default(cuid())
  userId    String
  type      String
  content   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserEvent {
  id        String   @id @default(cuid())
  userId    String
  type      String
  metadata  Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SubscriptionDiscount {
  id              String           @id @default(cuid())
  subscriptionId  String
  userId          String
  discountPercent Float
  originalPrice   Float
  discountedPrice Float
  stripeCouponId  String?
  appliedAt       DateTime         @default(now())
  expiresAt       DateTime?
  isActive        Boolean          @default(true)
  reason          String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  subscription    UserSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model HealthcareEmployer {
  id            String       @id @default(cuid())
  name          String       @unique
  slug          String       @unique
  careerPageUrl String
  atsPlatform   String?
  isActive      Boolean      @default(true)
  lastScraped   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  jobs          NursingJob[]
  jobAlerts     JobAlert[]

  @@index([isActive, lastScraped])
}

model NursingJob {
  id                    String             @id @default(cuid())
  title                 String
  employerId            String
  location              String
  city                  String
  state                 String
  zipCode               String?
  jobType               String?
  specialty             String?
  experienceLevel       String?
  description           String
  requirements          String?
  responsibilities      String?
  benefits              String?
  department            String?
  brand                 String?
  salaryMin             Int?
  salaryMax             Int?
  salaryCurrency        String?            @default("USD")
  sourceUrl             String             @unique
  sourceJobId           String?
  isActive              Boolean            @default(true)
  postedDate            DateTime?
  expiresDate           DateTime?
  slug                  String             @unique
  metaDescription       String?
  keywords              String[]
  scrapedAt             DateTime           @default(now())
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  calculatedExpiresDate DateTime?
  salaryMaxAnnual       Int?
  salaryMaxHourly       Int?
  salaryMinAnnual       Int?
  salaryMinHourly       Int?
  salaryType            String?
  shiftType             String?
  classifiedAt          DateTime?
  googleIndexedAt       DateTime?
  hasSignOnBonus        Boolean            @default(false)
  signOnBonusAmount     Int?
  wasEverActive         Boolean            @default(false)
  rawDescription        String?
  workArrangement       WorkArrangement?
  educationLevel        EducationLevel?
  employer              HealthcareEmployer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([state, city])
  @@index([specialty])
  @@index([employerId, isActive])
  @@index([isActive, scrapedAt])
  @@index([slug])
  @@index([jobType, specialty])
}

model Location {
  id        String  @id @default(cuid())
  city      String
  state     String
  stateFull String
  region    String?

  @@unique([city, state])
  @@index([state])
}

model DeletedJob {
  id        String   @id @default(cuid())
  slug      String   @unique
  deletedAt DateTime @default(now())
  reason    String?

  @@index([slug])
}

model JobAlert {
  id               String              @id @default(cuid())
  email            String
  name             String?
  specialty        String
  location         String
  state            String?
  city             String?
  employerId       String?
  source           String
  active           Boolean             @default(true)
  unsubscribeToken String              @unique @default(cuid())
  createdAt        DateTime            @default(now())
  lastEmailSent    DateTime?
  employer         HealthcareEmployer? @relation(fields: [employerId], references: [id])

  @@index([email, active])
  @@index([specialty, state])
  @@index([unsubscribeToken])
  @@map("jobalert")
}

model AnalyticsEvent {
  id        Int      @id @default(autoincrement())
  sessionId String
  eventType String
  email     String?
  jobId     String?
  jobSlug   String?
  sourceUrl String
  employer  String?
  specialty String?
  state     String?
  city      String?
  createdAt DateTime @default(now())

  @@index([eventType, createdAt])
  @@index([sessionId])
  @@index([email])
  @@index([createdAt])
}

enum WorkArrangement {
  remote
  hybrid
  onsite
}

// Education level for Google JobPosting structured data
// Values match Google's credentialCategory requirements
enum EducationLevel {
  associate_degree
  bachelor_degree
  professional_certificate
  postgraduate_degree
}

// Google Search Console monitoring tables
model GscPageMetric {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  page        String
  clicks      Int      @default(0)
  impressions Int      @default(0)
  ctr         Float    @default(0)
  position    Float    @default(0)
  createdAt   DateTime @default(now())

  @@unique([date, page])
  @@index([date])
  @@index([page])
}

model GscQueryMetric {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  query       String
  clicks      Int      @default(0)
  impressions Int      @default(0)
  ctr         Float    @default(0)
  position    Float    @default(0)
  createdAt   DateTime @default(now())

  @@unique([date, query])
  @@index([date])
  @@index([query])
}

model GscAlert {
  id            Int      @id @default(autoincrement())
  date          DateTime @db.Date
  severity      String
  category      String
  title         String
  description   String
  metric        String?
  entityType    String?
  entity        String?
  currentValue  Float?
  previousValue Float?
  changePercent Float?
  createdAt     DateTime @default(now())

  @@index([date])
  @@index([severity])
}

model GscSiteSummary {
  id                 Int      @id @default(autoincrement())
  date               DateTime @db.Date @unique
  totalClicks        Int      @default(0)
  totalImpressions   Int      @default(0)
  avgCtr             Float    @default(0)
  avgPosition        Float    @default(0)
  totalPages         Int      @default(0)
  totalQueries       Int      @default(0)
  mobileClicks       Int?
  mobileImpressions  Int?
  desktopClicks      Int?
  desktopImpressions Int?
  aiSummary          String?
  createdAt          DateTime @default(now())
}

model GscUrlInspection {
  id                     Int      @id @default(autoincrement())
  page                   String
  inspectedAt            DateTime @db.Date
  verdict                String
  coverageState          String?
  indexingState           String?
  crawledAs              String?
  lastCrawlTime          DateTime?
  pageFetchState         String?
  robotsTxtState         String?
  userCanonical          String?
  googleCanonical        String?
  referringUrls          String[]
  sitemap                String?
  richResultsVerdict     String?
  richResultsTypes       String[]
  richResultsIssues      Json?
  mobileUsabilityVerdict String?
  mobileUsabilityIssues  Json?
  createdAt              DateTime @default(now())

  @@unique([page, inspectedAt])
  @@index([inspectedAt])
  @@index([page])
  @@index([verdict])
}

model GscSitemapStatus {
  id             Int       @id @default(autoincrement())
  date           DateTime  @db.Date
  path           String
  lastDownloaded DateTime?
  lastSubmitted  DateTime?
  isPending      Boolean   @default(false)
  errors         Int       @default(0)
  warnings       Int       @default(0)
  contents       Json?
  createdAt      DateTime  @default(now())

  @@unique([date, path])
  @@index([date])
}

model GscDeviceMetric {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  device      String
  clicks      Int      @default(0)
  impressions Int      @default(0)
  ctr         Float    @default(0)
  position    Float    @default(0)
  createdAt   DateTime @default(now())

  @@unique([date, device])
  @@index([date])
}

model GscPageQueryMetric {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  page        String
  query       String
  clicks      Int      @default(0)
  impressions Int      @default(0)
  ctr         Float    @default(0)
  position    Float    @default(0)
  createdAt   DateTime @default(now())

  @@unique([date, page, query])
  @@index([date])
  @@index([page])
  @@index([query])
}

// ─── Bing Webmaster Tools Models ────────────────────────────────────

model BingPageMetric {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  page        String
  clicks      Int      @default(0)
  impressions Int      @default(0)
  ctr         Float    @default(0)
  position    Float    @default(0)
  createdAt   DateTime @default(now())

  @@unique([date, page])
  @@index([date])
  @@index([page])
}

model BingQueryMetric {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  query       String
  clicks      Int      @default(0)
  impressions Int      @default(0)
  ctr         Float    @default(0)
  position    Float    @default(0)
  createdAt   DateTime @default(now())

  @@unique([date, query])
  @@index([date])
  @@index([query])
}

model BingAlert {
  id            Int      @id @default(autoincrement())
  date          DateTime @db.Date
  severity      String
  category      String
  title         String
  description   String
  metric        String?
  entityType    String?
  entity        String?
  currentValue  Float?
  previousValue Float?
  changePercent Float?
  createdAt     DateTime @default(now())

  @@index([date])
  @@index([severity])
}

model BingSiteSummary {
  id               Int      @id @default(autoincrement())
  date             DateTime @db.Date @unique
  totalClicks      Int      @default(0)
  totalImpressions Int      @default(0)
  avgCtr           Float    @default(0)
  avgPosition      Float    @default(0)
  totalPages       Int      @default(0)
  totalQueries     Int      @default(0)
  aiSummary        String?
  createdAt        DateTime @default(now())
}
